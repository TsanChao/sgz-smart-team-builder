# 游戏公告监控与数据更新方案

## 1. 概述

本方案旨在通过监控三国志战略版官方公告，及时获取游戏数据更新信息，并相应地维护本地数据。重点关注标题包含"维护更新公告"的公告内容。

## 2. 技术实现方案

### 2.1 公告监控机制

我们将实现一个监控脚本，定期调用官方API获取最新公告列表，并筛选出"维护更新公告"，然后检查是否有新的更新需要处理。

### 2.2 API接口说明

1. **获取公告列表**
   - URL: `https://galaxias-api.lingxigames.com/ds/ajax/endpoint.json`
   - 方法: POST
   - 参数:
     ```json
     {
       "api": "/api/l/owresource/getListRecommend",
       "params": {
         "gameId": 10000100,
         "collectionIds": 128,
         "orderCode": 1,
         "orderDesc": true,
         "page": 1,
         "size": 20
       }
     }
     ```

2. **获取公告详情**
   - URL: `https://galaxias-api.lingxigames.com/ds/ajax/endpoint.json`
   - 方法: POST
   - 参数:
     ```json
     {
       "api": "/api/l/owresource/getInfoDetail",
       "params": {
         "gameId": 10000100,
         "id": "公告ID"
       }
     }
     ```

### 2.3 监控脚本实现

```python
import requests
import json
import hashlib
import os
from datetime import datetime

class SGZAnnouncementMonitor:
    def __init__(self):
        self.base_url = "https://galaxias-api.lingxigames.com/ds/ajax/endpoint.json"
        self.game_id = 10000100
        self.collection_id = 128
        self.checkpoint_file = "last_processed_announcement.json"
        
    def get_announcement_list(self, page=1, size=20):
        """获取公告列表"""
        payload = {
            "api": "/api/l/owresource/getListRecommend",
            "params": {
                "gameId": self.game_id,
                "collectionIds": self.collection_id,
                "orderCode": 1,
                "orderDesc": True,
                "page": page,
                "size": size
            }
        }
        
        try:
            response = requests.post(self.base_url, json=payload)
            if response.status_code == 200:
                return response.json()
            else:
                print(f"获取公告列表失败，状态码: {response.status_code}")
                return None
        except Exception as e:
            print(f"请求公告列表时出错: {e}")
            return None
    
    def get_announcement_detail(self, announcement_id):
        """获取公告详情"""
        payload = {
            "api": "/api/l/owresource/getInfoDetail",
            "params": {
                "gameId": self.game_id,
                "id": str(announcement_id)
            }
        }
        
        try:
            response = requests.post(self.base_url, json=payload)
            if response.status_code == 200:
                return response.json()
            else:
                print(f"获取公告详情失败，状态码: {response.status_code}")
                return None
        except Exception as e:
            print(f"请求公告详情时出错: {e}")
            return None
    
    def filter_maintenance_announcements(self, announcements):
        """筛选维护更新公告"""
        maintenance_announcements = []
        for item in announcements.get("data", {}).get("list", []):
            title = item.get("title", "")
            if "维护更新公告" in title:
                maintenance_announcements.append(item)
        return maintenance_announcements
    
    def load_checkpoint(self):
        """加载检查点"""
        if os.path.exists(self.checkpoint_file):
            with open(self.checkpoint_file, 'r', encoding='utf-8') as f:
                return json.load(f)
        return {}
    
    def save_checkpoint(self, data):
        """保存检查点"""
        with open(self.checkpoint_file, 'w', encoding='utf-8') as f:
            json.dump(data, f, ensure_ascii=False, indent=2)
    
    def check_for_updates(self):
        """检查是否有新的维护更新公告"""
        # 获取最新的公告列表
        announcement_list = self.get_announcement_list()
        if not announcement_list:
            return False
            
        # 筛选维护更新公告
        maintenance_announcements = self.filter_maintenance_announcements(announcement_list)
        if not maintenance_announcements:
            print("未找到新的维护更新公告")
            return False
            
        # 获取最新的维护更新公告
        latest_announcement = maintenance_announcements[0]
        latest_id = latest_announcement.get("id")
        latest_title = latest_announcement.get("title")
        latest_time = latest_announcement.get("publishTime")
        
        print(f"最新的维护更新公告: {latest_title} (ID: {latest_id})")
        
        # 加载检查点
        checkpoint = self.load_checkpoint()
        last_processed_id = checkpoint.get("last_processed_id")
        
        # 检查是否是新公告
        if str(latest_id) != str(last_processed_id):
            print("发现新的维护更新公告!")
            # 获取公告详情
            detail = self.get_announcement_detail(latest_id)
            if detail:
                # 保存检查点
                checkpoint_data = {
                    "last_processed_id": latest_id,
                    "title": latest_title,
                    "publish_time": latest_time,
                    "processed_time": datetime.now().isoformat()
                }
                self.save_checkpoint(checkpoint_data)
                
                # 这里可以触发数据更新流程
                self.process_update_announcement(detail)
                return True
        else:
            print("没有新的维护更新公告")
            
        return False
    
    def process_update_announcement(self, announcement_detail):
        """处理更新公告"""
        # 这里实现具体的公告内容解析和数据更新逻辑
        print("开始处理更新公告...")
        # 公告内容解析
        content = announcement_detail.get("data", {}).get("infoDetail", {}).get("content", "")
        title = announcement_detail.get("data", {}).get("infoDetail", {}).get("title", "")
        
        print(f"公告标题: {title}")
        print("公告内容已获取，可以开始解析和更新数据...")
        
        # TODO: 实现公告内容解析和数据更新逻辑
        # 1. 解析公告中的武将/战法变更信息
        # 2. 更新本地数据文件
        # 3. 验证更新结果
        # 4. 记录更新日志

# 使用示例
if __name__ == "__main__":
    monitor = SGZAnnouncementMonitor()
    monitor.check_for_updates()
```

## 3. 数据更新流程

### 3.1 公告内容解析

1. 从公告详情中提取正文内容
2. 使用正则表达式或自然语言处理技术识别武将/战法变更信息
3. 将变更信息结构化处理

### 3.2 数据更新实现

1. 根据解析结果定位需要更新的武将/战法
2. 修改本地JSON数据文件中的对应条目
3. 保持数据格式一致性

### 3.3 更新验证

1. 验证更新后的数据格式是否正确
2. 检查关键字段是否完整
3. 确保数据逻辑一致性

## 4. 自动化部署

### 4.1 定时任务设置

可以使用操作系统的定时任务功能（如Linux的crontab）定期执行监控脚本：

```bash
# 每天上午9点执行一次检查
0 9 * * * /usr/bin/python3 /path/to/sgz_announcement_monitor.py
```

### 4.2 集成到现有系统

1. 将监控功能集成到智能配将程序中
2. 提供Web界面显示最近检查状态
3. 实现手动触发检查功能

## 5. 异常处理与日志记录

### 5.1 网络异常处理

1. 设置请求超时时间
2. 实现重试机制
3. 记录网络错误日志

### 5.2 数据异常处理

1. 验证API返回数据格式
2. 处理缺失字段情况
3. 记录数据异常日志

### 5.3 日志记录

实现详细的日志记录功能，包括：
1. 每次检查的时间和结果
2. 发现新公告的详细信息
3. 数据更新过程中的关键步骤
4. 异常情况和错误信息

## 6. 总结

通过实现这套监控机制，我们可以及时获取游戏更新信息，确保本地数据的时效性。该方案具有以下优势：

1. **自动化程度高**：减少人工检查公告的工作量
2. **准确性好**：直接从官方API获取数据，确保信息权威性
3. **可扩展性强**：易于添加新的监控规则和处理逻辑
4. **容错性好**：具备完善的异常处理和日志记录机制

后续可以根据实际使用情况进一步优化监控策略和数据处理逻辑。