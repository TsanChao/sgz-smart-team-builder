# 智能配将程序开发方案 (v13.0)

## 一、核心理念

本程序旨在成为一个专注于战法协同分析的智能化三国志战略版配将工具。与以往版本不同，本方案完全摒弃了单个武将评分机制，将核心 focus 完全放在阵容整体的战法协同效应上。整个应用包含四大核心模块：

1. **战法协同分析模块**: 提供核心的战法协同效应分析功能。
2. **智能配将模块**: 基于战法协同分析提供队伍搭配与战法推荐功能。
3. **数据管理模块**: 提供一个安全、直观的图形化界面，用于维护武将和战法数据。
4. **资源管理模块**: 负责管理和提供武将头像等静态资源。

## 二、项目架构设计

### 2.1 项目结构
```
项目根目录/
├── app.py                  # 后端主应用文件
├── config.py               # 配置文件
├── data/                   # 数据处理模块
│   ├── data_manager.py     # 数据管理器
│   └── consolidated_ocr_data.json  # 数据文件
├── core/                   # 核心逻辑模块
│   ├── synergy_analyzer.py # 战法协同分析器 (核心模块)
│   ├── recommender.py      # 推荐引擎
│   ├── level_calculator.py # 等级属性计算器
│   └── damage_calculator.py # 伤害计算器
├── api/                    # API接口模块
│   └── routes.py           # 路由定义
├── static/                 # 前端静态文件
│   ├── css/
│   ├── js/
│   └── index.html
└── assets/portraits/       # 武将头像图片
```

### 2.2 核心模块设计

#### 2.2.1 数据管理模块 (DataManager)
负责所有数据的读取、查询和管理操作。

#### 2.2.2 战法协同分析器模块 (SynergyAnalyzer) (核心模块)
负责分析战法间的协同效应，是整个应用的核心。

#### 2.2.3 推荐模块 (Recommender)
基于协同分析结果，实现阵容推荐算法。

#### 2.2.4 等级计算器模块 (LevelCalculator)
负责计算武将在不同等级时的属性值，为协同分析提供数据支持。

#### 2.2.5 伤害计算器模块 (DamageCalculator)
负责计算武将战法的伤害值和治疗量，用于验证协同效果。

## 三、战法协同分析机制 (核心章节)

### 3.1 战法标签系统
为不同类型的战法效果建立标签体系：
- **控制类**：缴械、震慑、计穷、混乱等
- **增益类**：增伤、减伤、急救等
- **状态类**：灼烧、中毒、溃逃等
- **输出类**：兵刃、谋略等
- **辅助类**：治疗、净化、护盾等

### 3.2 战法协同矩阵
定义不同战法标签间的协同关系和强度值：
- **高协同**：控制+输出、灼烧+爆发等
- **中协同**：增伤+增伤、治疗+护盾等
- **低协同**：同类效果叠加等

### 3.3 队伍角色评估
识别队伍中各武将的战术定位：
- **输出角色**：主要负责伤害输出
- **控制角色**：主要负责控制敌军
- **辅助角色**：主要负责治疗和增益
- **坦克角色**：主要负责承受伤害

### 3.4 协同效应评分算法
基于以下维度计算阵容协同评分：
1. **战法标签匹配度**：队伍中战法标签的多样性和互补性
2. **战法协同效应**：根据协同矩阵计算战法间的协同强度
3. **队伍角色完整性**：队伍中各类角色的完整性和平衡性
4. **战术定位适配性**：武将与其战术角色的适配程度
5. **阵营和兵种搭配合理性**：阵营加成和兵种克制的利用

协同评分计算公式：
```
协同评分 = 战法协同加成 + 角色搭配加成 + 战术适配加成 + 阵营兵种加成
```

## 四、等级属性计算机制

### 4.1 属性成长规则
- **基础属性**: 从JSON数据中获取的1级属性值
- **成长属性**: 从JSON数据中获取的成长值
- **自由分配点数**: 每10级获得10点自由分配属性点
- **计算公式**: 
  ```
  N级属性值 = 基础属性 + (N-1) × 成长值 + 自由分配点数
  其中自由分配点数 = floor((N-1)/10) × 10
  ```

### 4.2 示例计算
以关羽为例（1级武力97，成长2.68）：
- 1级武力: 97.00
- 20级武力: 97 + 19×2.68 + 1×10 = 97 + 50.92 + 10 = 157.92
- 50级武力: 97 + 49×2.68 + 4×10 = 97 + 131.32 + 40 = 268.32

### 4.3 等级选择策略
- **默认推荐等级**: 50级（游戏中的常见对战等级）
- **可选等级**: 1级、20级、30级、40级、50级
- **自定义等级**: 支持用户指定特定等级进行计算

## 五、伤害计算机制

### 5.1 伤害类型分类
- **兵刃伤害**: 基于武力值计算的物理攻击伤害
- **谋略伤害**: 基于智力值计算的法术攻击伤害
- **治疗效果**: 基于智力值计算的兵力恢复量

### 5.2 伤害计算总公式
根据《三国志战略版》实际伤害计算机制，总伤害由兵力伤害和武将伤害两部分组成：
```
总伤害 = (兵力伤害 + 武将伤害) × 技能系数 × 增减伤系数 × 会心系数 × 其他乘区系数
```

### 5.3 兵力伤害公式
```
兵力伤害 = 0.1877 × 兵力^{0.32} × 属性差
```
其中：
- **兵力**：攻击方武将的带兵数量
- **属性差**：兵刃伤害为(攻击方武力-防守方统率)，谋略伤害为(攻击方智力-防守方智力)

### 5.4 武将伤害公式
```
武将伤害 = 0.0005 × 属性差² + 0.9 × 属性差 + 4.5
```
其中：
- **属性差**：兵刃伤害为(攻击方武力-防守方统率)，谋略伤害为(攻击方智力-防守方智力)

## 六、后端API与核心逻辑开发

### 步骤 1: 项目结构初始化
- **任务**: 创建项目文件夹结构，包括后端应用目录、前端静态文件目录以及资源目录。
    - `app.py`: 后端主应用文件。
    - `config.py`: 配置文件，管理权重参数等。
    - `static/`: 用于存放前端HTML/CSS/JS文件。
    - `assets/portraits/`: 专门用于存放武将头像图片。

### 步骤 2: 数据模块 (`DataManager`) 设计与实现
- **任务**: 创建一个 `DataManager` 类，作为应用中唯一的数据访问点，封装所有对 `consolidated_ocr_data.json` 的读写操作。
- **数据结构 (`武将` 对象)**:
    ```json
    "曹操": {
      "阵营": "魏",
      "统御": 7,
      "标签": ["辅", "盾"],
      "头像": "assets/portraits/曹操.png",
      "兵种": { ... },
      "属性": { ... },
      "自带战法": "乱世奸雄",
      "传承战法": "梦中弑臣"
    }
    ```
- **核心功能**:
    - **初始化与加载**: 加载JSON文件到内存。
    - **数据查询**: `get_hero_details`, `get_skill_details`, `get_all_heroes`, `get_all_skills`。
    - **标签识别**: `get_combat_heroes` (配将引擎主要数据源), `get_admin_heroes`。
    - **数据修改**: `add_hero`, `update_hero`, `delete_hero` 及对应的战法管理方法。所有写操作均需调用内部的 `_save_data()` 方法。

### 步骤 3: 战法协同分析器模块设计 (核心模块)
- **任务**: 创建 `SynergyAnalyzer` 类，作为整个应用的核心，用于分析战法间的协同效应。
- **核心功能**:
    - `analyze_synergy(hero_team)`: 分析队伍中战法的协同效应
    - `calculate_role_balance(hero_team)`: 计算队伍角色搭配的平衡性
    - `evaluate_tactical_fit(hero, role)`: 评估武将在特定角色中的适配性
    - `get_synergy_score(hero_team)`: 获取队伍协同评分
    - `get_synergy_details(hero_team)`: 获取详细的协同分析报告

### 步骤 4: 等级计算器模块设计
- **任务**: 创建 `LevelCalculator` 类，用于计算武将在不同等级时的属性值，为协同分析提供数据支持。
- **核心功能**:
    - `calculate_attributes(hero_data, level)`: 计算指定等级的属性值
    - `get_level_options()`: 获取可选等级列表
    - `calculate_free_points(level)`: 计算自由分配点数

### 步骤 5: 伤害计算器模块设计
- **任务**: 创建 `DamageCalculator` 类，用于计算武将战法的伤害值和治疗量，用于验证协同效果。
- **核心功能**:
    - `calculate_damage(skill_data, attacker_attributes, defender_attributes, level, troop_count)`: 计算战法伤害，新增兵力参数
    - `calculate_heal(skill_data, healer_attributes, target_attributes, level)`: 计算治疗量
    - `get_damage_type(skill_data)`: 获取伤害类型（兵刃/谋略）
    - `calculate_skill_rate(skill_data, level)`: 根据等级计算战法实际伤害率/治疗率

### 步骤 6: 核心配将逻辑
- **任务**: 基于 `DataManager`、`SynergyAnalyzer`、`LevelCalculator` 和 `DamageCalculator` 提供的数据，实现游戏的核心规则与推荐算法。
- **调用流程**: 
    1. 从 `DataManager.get_combat_heroes()` 获取候选武将
    2. 使用 `SynergyAnalyzer` 分析所有可能组合的战法协同效应
    3. 使用 `LevelCalculator` 计算50级属性值（为协同分析提供数据支持）
    4. 使用 `DamageCalculator` 验证协同效果
    5. 基于协同分析结果进行推荐
- **推荐算法实现**:
    - 生成所有可能的3人组合
    - 使用 `SynergyAnalyzer.get_synergy_score()` 计算每个组合的协同评分
    - 考虑不同兵力数量下的协同效果进行综合评估
    - 返回协同评分最高的N个组合

### 步骤 7: 后端API层
- **任务**: 使用Flask/FastAPI，将所有后端功能封装成API。
    - **静态文件服务**: 配置后端应用，使其能够对外提供 `assets` 目录下的静态资源（头像图片）。
    - **配将API**: `/api/recommend`
    - **数据管理CRUD API**: `/api/heroes`, `/api/skills` 及其子路由。
    - **协同分析API**: `/api/synergy` (核心API)
    - **伤害计算API**: `/api/damage`

#### 7.1 API接口详细设计
```
POST /api/recommend
请求参数:
{
  "数量": 10,           // 可选，默认10
  "必须包含": "关羽",    // 可选
  "排除武将": "张飞",    // 可选
  "等级": 50,           // 可选，默认50级
  "兵力": 10000,        // 可选，默认10000
  "伤害验证": true      // 可选，是否进行伤害验证，默认true
}
响应:
[
  {
    "阵容": ["曹操", "夏侯惇", "荀彧"],
    "协同评分": 85.2,
    "阵营加成": "+15%",
    "兵种搭配": ["骑兵", "盾兵", "弓兵"],
    "等级": 50
  }
]

GET /api/hero/{name}
参数: ?level=50  // 可选，默认50级
响应: 武将详细信息（包含指定等级的属性值）

GET /api/skill/{name}
响应: 战法详细信息

GET /api/heroes
响应: 所有武将列表

GET /api/skills
响应: 所有战法列表

GET /api/levels
响应: 可选等级列表 [1, 20, 30, 40, 50]

POST /api/synergy  // 核心API
请求参数:
{
  "阵容": ["关羽", "张飞", "刘备"],
  "等级": 50
}
响应: 队伍协同分析结果，包括详细的协同评分和分析报告

POST /api/damage
请求参数:
{
  "攻击方": "关羽",
  "防守方": "曹操",
  "战法": "威震华夏",
  "等级": 50,
  "攻击方兵力": 10000,   // 可选，默认10000
  "防守方兵力": 10000    // 可选，默认10000
}
响应: 伤害计算结果，用于验证协同效果
```

## 七、前端用户界面开发

### 步骤 1: 基础页面框架
- **任务**: 创建一个单页面应用（SPA）框架，包含顶部导航栏，用于在"智能配将"和"数据管理"两大模块间切换。

### 步骤 2: "智能配将"模块UI详细设计

#### 2.1 整体界面布局
```
┌─────────────────────────────────────────────────────────────┐
│  三国志战略版智能配将工具                                   │
├─────────────────────────────────────────────────────────────┤
│  [智能配将] │ [数据管理] │ [关于]                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│                    主内容区域                               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 2.2 配将条件设置面板
```
┌─────────────────────────────────────────────────────────────┐
│  阵容推荐设置                                               │
├─────────────────────────────────────────────────────────────┤
│  必须包含武将: [下拉选择框]                                 │
│  排除武将:   [下拉选择框]                                   │
│  推荐等级:   [50级] [▼]  // 可选1/20/30/40/50级             │
│  推荐数量:   [10] [▲▼]                                      │
│  兵力数量:   [10000] [▲▼]                                   │
│  伤害验证:   [√] 启用伤害验证                               │
│                                                             │
│  [开始推荐] [重置条件]                                     │
└─────────────────────────────────────────────────────────────┘
```

#### 2.3 推荐结果展示区域
```
┌─────────────────────────────────────────────────────────────┐
│  推荐阵容 (共找到 10 套阵容)  [50级属性计算]                │
├─────────────────────────────────────────────────────────────┤
│  №1  协同评分: 85.2     阵营加成: +15%    兵种: 骑/盾/弓    │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐                        │
│  │  关羽   │ │  张飞   │ │  刘备   │                        │
│  │ (主将)  │ │(副将1)  │ │(副将2)  │                        │
│  │ 武力268 │ │ 武力271 │ │ 统率258 │                        │
│  │ 骑/S    │ │ 枪/S    │ │ 盾/S    │                        │
│  └─────────┘ └─────────┘ └─────────┘                        │
│  协同说明: 控制+输出完美配合，治疗保障生存                  │
│  [查看详情] [协同分析] [伤害验证]                           │
└─────────────────────────────────────────────────────────────┘
```

#### 2.4 协同分析弹窗（核心功能）
```
┌─────────────────────────────────────────────────────────────┐
│  协同分析 - 蜀国队                                          │
├─────────────────────────────────────────────────────────────┤
│  队伍协同评分: 85.2                                         │
│                                                             │
│  战法协同效应:                                              │
│  • 张飞控制战法与关羽输出战法形成高协同 (+25.3分)           │
│  • 刘备治疗战法保障队伍生存 (+18.7分)                       │
│  • 蜀国阵营加成提升整体属性 (+12.5分)                       │
│  • 兵种搭配合理，无明显克制关系 (+8.7分)                    │
│                                                             │
│  队伍角色搭配:                                              │
│  • 输出角色: 关羽 (主输出)                                  │
│  • 控制角色: 张飞 (控制)                                    │
│  • 辅助角色: 刘备 (治疗)                                    │
│  • 坦克角色: 无                                             │
│  角色完整性: 75%                                            │
│                                                             │
│  改进建议:                                                  │
│  • 可考虑替换刘备为具有坦克属性的武将以提高队伍完整性       │
│                                                             │
│                    [关闭]                                   │
└─────────────────────────────────────────────────────────────┘
```

### 步骤 3: "数据管理"模块UI详细设计

#### 3.1 武将管理界面
```
┌─────────────────────────────────────────────────────────────┐
│  武将管理                                                   │
├─────────────────────────────────────────────────────────────┤
│  [新增武将] [导入数据] [导出数据] [刷新]                    │
├─────────────────────────────────────────────────────────────┤
│  搜索: [___________________________]                        │
│                                                             │
│  ┌─────┬─────┬──────┬──────┬────────┬─────────────────────┐ │
│  │ 头像│ 姓名│ 阵营 │ 统御 │ 标签   │ 操作                │ │
│  ├─────┼─────┼──────┼──────┼────────┼─────────────────────┤ │
│  │ [图]│ 关羽│ 蜀   │ 7    │ [武][战]│ [编辑][删除]        │ │
│  │ [图]│ 曹操│ 魏   │ 7    │ [谋][辅]│ [编辑][删除]        │ │
│  │ [图]│ 刘备│ 蜀   │ 6    │ [政][魅]│ [编辑][删除]        │ │
│  └─────┴─────┴──────┴──────┴────────┴─────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 八、开发优先级

### 8.1 第一阶段（最小可行产品）
1. 实现基础数据管理功能
2. 实现战法协同分析器（核心模块）
3. 实现基础阵容推荐功能（基于协同评分）
4. 实现前后端基本交互
5. 实现核心API接口（/api/synergy, /api/recommend）

### 8.2 第二阶段（功能完善）
1. 完善协同分析算法
2. 优化推荐算法
3. 增强用户界面交互体验
4. 实现多等级切换功能
5. 实现伤害计算API（用于验证协同效果）

### 8.3 第三阶段（高级功能）
1. 实现高级协同分析算法
2. 增加个性化推荐功能
3. 实现用户偏好学习
4. 增加协同效应可视化功能
5. 实现队伍战术风格识别功能

## 九、扩展性设计

### 9.1 模块化设计
- 协同分析算法独立成模块，便于后续优化
- 推荐算法接口化，支持多种推荐策略
- 配置参数化，权重等参数通过配置文件管理
- 等级计算模块化，支持不同等级计算规则
- 伤害计算模块化，支持不同伤害类型计算

### 9.2 后续扩展方向
- 完善协同分析算法，增加更多协同类型
- 增加战斗场景适配功能
- 添加用户偏好学习功能
- 支持多版本数据管理
- 增加协同效应可视化功能
- 实现队伍战术风格识别功能
- 增加协同分析的历史记录和对比功能

## 十、更新管理机制

### 10.1 数据更新机制
为了保持程序数据的时效性，建立定期的数据更新机制：

1. **官方资料追踪**：
   - 定期访问三国志战略版官方网站和资料站
   - 关注游戏公告和更新内容
   - 记录武将、战法的更新信息

2. **数据同步**：
   - 建立标准化的数据更新流程
   - 开发数据更新脚本，简化更新操作
   - 增加版本控制，保证数据更新的可追溯性

3. **自动化检查**：
   - 实现消费检查点机制，监控官方网站更新
   - 及时发现数据变化并提醒开发者

### 10.2 用户反馈机制
- 建立用户反馈渠道，收集用户在使用过程中发现的问题
- 鼓励用户提交武将/战法数据更新建议
- 定期整理用户反馈，作为数据更新的重要参考

### 10.3 版本发布策略
- 每次重大更新后发布新版本
- 保持版本号的语义化（主版本号.次版本号.修订号）
- 每个版本更新都附带详细的更新日志